<!DOCTYPE html>
<html>
<head>
    <title>Chart API Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e9; color: #2e7d32; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>Monthly Reports Chart API Debug</h1>

    <div>
        <button onclick="testChartAPI()">Test Chart API</button>
        <button onclick="testWithAuth()">Test with Auth Headers</button>
        <button onclick="clearResults()">Clear Results</button>
    </div>

    <div id="results"></div>

    <script>
        function addResult(message, isError = false) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = 'result ' + (isError ? 'error' : 'success');
            div.innerHTML = '<strong>' + new Date().toLocaleTimeString() + '</strong>: ' + message;
            results.appendChild(div);
        }

        async function testChartAPI() {
            addResult('Testing chart API...');

            try {
                const response = await fetch('/admin/monthly-reports/chart-data', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                addResult(`Response Status: ${response.status} ${response.statusText}`);

                const text = await response.text();

                if (text.startsWith('<')) {
                    addResult('ERROR: Received HTML instead of JSON (likely auth redirect)', true);
                    addResult('HTML Preview: ' + text.substring(0, 200) + '...', true);
                } else {
                    try {
                        const data = JSON.parse(text);
                        addResult('SUCCESS: Received JSON data');
                        addResult('Data keys: ' + Object.keys(data).join(', '));
                        addResult('Full response: ' + JSON.stringify(data, null, 2));
                    } catch (e) {
                        addResult('ERROR: Invalid JSON - ' + e.message, true);
                        addResult('Raw response: ' + text, true);
                    }
                }

            } catch (error) {
                addResult('ERROR: ' + error.message, true);
            }
        }

        async function testWithAuth() {
            addResult('Testing with auth headers...');

            // Get CSRF token
            const tokenElement = document.querySelector('meta[name="csrf-token"]');
            const csrfToken = tokenElement ? tokenElement.getAttribute('content') : 'none';

            try {
                const response = await fetch('/admin/monthly-reports/chart-data', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRF-TOKEN': csrfToken,
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin'
                });

                addResult(`Response Status: ${response.status} ${response.statusText}`);

                const contentType = response.headers.get('content-type');
                addResult(`Content-Type: ${contentType}`);

                const text = await response.text();

                if (text.startsWith('<')) {
                    addResult('ERROR: Still receiving HTML - check authentication', true);
                } else {
                    try {
                        const data = JSON.parse(text);
                        addResult('SUCCESS: Auth working, received JSON');
                        addResult('Data summary: ' + (data.summary ? JSON.stringify(data.summary) : 'No summary'));
                    } catch (e) {
                        addResult('ERROR: Invalid JSON - ' + e.message, true);
                    }
                }

            } catch (error) {
                addResult('ERROR: ' + error.message, true);
            }
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        // Auto-test on page load
        document.addEventListener('DOMContentLoaded', function() {
            addResult('Page loaded. Click buttons to test API.');
        });
    </script>
</body>
</html>
